#include <stdio.h>
#include <time.h>
#include "util.c"
char *moon();
char *dangi();

main(int argc, char **argv)
{
	int n;
	findport(tty);
	read_cfg();
	set_tmpfile();
	if (strlen(argv[1])>2) read_pf(argv[1]);
	n=now_year();
	if (n<100) n+=1900;
	n+=2333;
	printf(" [최근사용] %s\n",datestr(33,pf.logout));
	printf(" [현재시간] %s  ◆음력:%s   ◆단기:%d년\n",now_str(33),moon(),n);
	printf(" [사용시간] %s (%d월1일부터)\n",datestr(20,pf.month_time),now_month());
}

char *moon(void)
{
	static char outbuff[100];
	static char kk[163][13] = {

	  /*1881*/	 1, 2, 1, 2, 1, 2, 2, 3, 2, 2, 1, 2, 1,
				 1, 2, 1, 2, 1, 2, 1, 2, 2, 1, 2, 2, 0,
				 1, 1, 2, 1, 1, 2, 1, 2, 2, 2, 1, 2, 0,
				 2, 1, 1, 2, 1, 3, 2, 1, 2, 2, 1, 2, 2,
				 2, 1, 1, 2, 1, 1, 2, 1, 2, 1, 2, 2, 0,
				 2, 1, 2, 1, 2, 1, 1, 2, 1, 2, 1, 2, 0,
				 2, 2, 1, 2, 3, 2, 1, 1, 2, 1, 2, 1, 2,
				 2, 1, 2, 2, 1, 2, 1, 1, 2, 1, 2, 1, 0,
				 2, 1, 2, 2, 1, 2, 1, 2, 1, 2, 1, 2, 0,
				 1, 2, 3, 2, 1, 2, 2, 1, 2, 1, 2, 1, 2,

	  /*1891*/	 1, 2, 1, 2, 1, 2, 1, 2, 2, 1, 2, 2, 0,
				 1, 1, 2, 1, 1, 2, 3, 2, 2, 1, 2, 2, 2,
				 1, 1, 2, 1, 1, 2, 1, 2, 1, 2, 2, 2, 0,
				 1, 2, 1, 2, 1, 1, 2, 1, 2, 1, 2, 2, 0,
				 2, 1, 2, 1, 2, 3, 1, 2, 1, 2, 1, 2, 1,
				 2, 2, 2, 1, 2, 1, 1, 2, 1, 2, 1, 2, 0,
				 1, 2, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 0,
				 2, 1, 2, 3, 2, 2, 1, 2, 1, 2, 1, 2, 1,
				 2, 1, 2, 1, 2, 1, 2, 2, 1, 2, 1, 2, 0,
				 1, 2, 1, 1, 2, 1, 2, 2, 3, 2, 2, 1, 2,

	  /*1901*/	 1, 2, 1, 1, 2, 1, 2, 1, 2, 2, 2, 1, 0,
				 2, 1, 2, 1, 1, 2, 1, 2, 1, 2, 2, 2, 0,
				 1, 2, 1, 2, 1, 3, 2, 1, 1, 2, 2, 1, 2,
				 2, 2, 1, 2, 1, 1, 2, 1, 1, 2, 2, 1, 0,
				 2, 2, 1, 2, 2, 1, 1, 2, 1, 2, 1, 2, 0,
				 1, 2, 2, 1, 4, 1, 2, 1, 2, 1, 2, 1, 2,
				 1, 2, 1, 2, 1, 2, 2, 1, 2, 1, 2, 1, 0,
				 2, 1, 1, 2, 2, 1, 2, 1, 2, 2, 1, 2, 0,
				 1, 2, 3, 1, 2, 1, 2, 1, 2, 2, 2, 1, 2,
				 1, 2, 1, 1, 2, 1, 2, 1, 2, 2, 2, 1, 0,

	  /*1911*/	 2, 1, 2, 1, 1, 2, 3, 1, 2, 2, 1, 2, 2,
				 2, 1, 2, 1, 1, 2, 1, 1, 2, 2, 1, 2, 0,
				 2, 2, 1, 2, 1, 1, 2, 1, 1, 2, 1, 2, 0,
				 2, 2, 1, 2, 2, 3, 1, 2, 1, 2, 1, 1, 2,
				 2, 1, 2, 2, 1, 2, 1, 2, 1, 2, 1, 2, 0,
				 1, 2, 1, 2, 1, 2, 2, 1, 2, 1, 2, 1, 0,
				 2, 1, 3, 2, 1, 2, 2, 1, 2, 2, 1, 2, 1,
				 2, 1, 1, 2, 1, 2, 1, 2, 2, 2, 1, 2, 0,
				 1, 2, 1, 1, 2, 1, 2, 3, 2, 2, 1, 2, 2,
				 1, 2, 1, 1, 2, 1, 1, 2, 2, 1, 2, 2, 0,

	  /*1921*/	 2, 1, 2, 1, 1, 2, 1, 1, 2, 1, 2, 2, 0,
				 2, 1, 2, 2, 1, 3, 2, 1, 1, 2, 1, 2, 2,
				 1, 2, 2, 1, 2, 1, 2, 1, 2, 1, 1, 2, 0,
				 2, 1, 2, 1, 2, 2, 1, 2, 1, 2, 1, 1, 0,
				 2, 1, 2, 2, 3, 2, 1, 2, 2, 1, 2, 1, 2,
				 1, 1, 2, 1, 2, 1, 2, 2, 1, 2, 2, 1, 0,
				 2, 1, 1, 2, 1, 2, 1, 2, 2, 1, 2, 2, 0,
				 1, 2, 3, 1, 2, 1, 1, 2, 2, 1, 2, 2, 2,
				 1, 2, 1, 1, 2, 1, 1, 2, 1, 2, 2, 2, 0,
				 1, 2, 2, 1, 1, 2, 3, 1, 2, 1, 2, 2, 1,

	  /*1931*/	 2, 2, 2, 1, 1, 2, 1, 1, 2, 1, 2, 1, 0,
				 2, 2, 2, 1, 2, 1, 2, 1, 1, 2, 1, 2, 0,
				 1, 2, 2, 1, 2, 4, 1, 2, 1, 2, 1, 1, 2,
				 1, 2, 1, 2, 2, 1, 2, 2, 1, 2, 1, 2, 0,
				 1, 1, 2, 1, 2, 1, 2, 2, 1, 2, 2, 1, 0,
				 2, 1, 1, 4, 1, 2, 1, 2, 1, 2, 2, 2, 1,
				 2, 1, 1, 2, 1, 1, 2, 1, 2, 2, 2, 1, 0,
				 2, 2, 1, 1, 2, 1, 1, 4, 1, 2, 2, 1, 2,
				 2, 2, 1, 1, 2, 1, 1, 2, 1, 2, 1, 2, 0,
				 2, 2, 1, 2, 1, 2, 1, 1, 2, 1, 2, 1, 0,

	  /*1941*/	 2, 2, 1, 2, 2, 1, 4, 1, 1, 2, 1, 2, 1,
				 2, 1, 2, 2, 1, 2, 2, 1, 2, 1, 1, 2, 0,
				 1, 2, 1, 2, 1, 2, 2, 1, 2, 2, 1, 2, 0,
				 1, 1, 2, 1, 4, 1, 2, 1, 2, 2, 1, 2, 2,
				 1, 1, 2, 1, 1, 2, 1, 2, 2, 2, 1, 2, 0,
				 2, 1, 1, 2, 1, 1, 2, 1, 2, 2, 1, 2, 0,
				 2, 2, 3, 1, 2, 1, 1, 2, 1, 2, 1, 2, 2,
				 2, 1, 2, 1, 2, 1, 1, 2, 1, 2, 1, 2, 0,
				 2, 2, 1, 2, 1, 2, 1, 3, 2, 1, 2, 1, 2,
				 2, 1, 2, 2, 1, 2, 1, 1, 2, 1, 2, 1, 0,

	  /*1951*/	 2, 1, 2, 2, 1, 2, 1, 2, 1, 2, 1, 2, 0,
				 1, 2, 1, 2, 1, 4, 2, 1, 2, 1, 2, 1, 2,
				 1, 2, 1, 1, 2, 2, 1, 2, 2, 1, 2, 2, 0,
				 1, 1, 2, 1, 1, 2, 1, 2, 2, 1, 2, 2, 0,
				 2, 1, 1, 4, 1, 1, 2, 1, 2, 1, 2, 2, 2,
				 1, 2, 1, 2, 1, 1, 2, 1, 2, 1, 2, 2, 0,
				 2, 1, 2, 1, 2, 1, 1, 2, 3, 2, 1, 2, 2,
				 1, 2, 2, 1, 2, 1, 1, 2, 1, 2, 1, 2, 0,
				 1, 2, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 0,
				 2, 1, 2, 1, 2, 2, 3, 2, 1, 2, 1, 2, 1,

	  /*1961*/	 2, 1, 2, 1, 2, 1, 2, 2, 1, 2, 1, 2, 0,
				 1, 2, 1, 1, 2, 1, 2, 2, 1, 2, 2, 1, 0,
				 2, 1, 2, 1, 3, 2, 1, 2, 1, 2, 2, 2, 1,
				 2, 1, 2, 1, 1, 2, 1, 2, 1, 2, 2, 2, 0,
				 1, 2, 1, 2, 1, 1, 2, 1, 1, 2, 2, 1, 0,
				 2, 2, 2, 3, 2, 1, 1, 2, 1, 1, 2, 2, 1,
				 2, 2, 1, 2, 2, 1, 1, 2, 1, 2, 1, 2, 0,
				 1, 2, 2, 1, 2, 1, 2, 3, 2, 1, 2, 1, 2,
				 1, 2, 1, 2, 1, 2, 2, 1, 2, 1, 2, 1, 0,
				 2, 1, 1, 2, 2, 1, 2, 1, 2, 2, 1, 2, 0,

	  /*1971*/	 1, 2, 1, 1, 2, 3, 2, 1, 2, 2, 2, 1, 2,
				 1, 2, 1, 1, 2, 1, 2, 1, 2, 2, 2, 1, 0,
				 2, 1, 2, 1, 1, 2, 1, 1, 2, 2, 2, 1, 0,
				 2, 2, 1, 2, 3, 1, 2, 1, 1, 2, 2, 1, 2,
				 2, 2, 1, 2, 1, 1, 2, 1, 1, 2, 1, 2, 0,
				 2, 2, 1, 2, 1, 2, 1, 2, 3, 2, 1, 1, 2,
				 2, 1, 2, 2, 1, 2, 1, 2, 1, 2, 1, 1, 0,
				 2, 2, 1, 2, 1, 2, 2, 1, 2, 1, 2, 1, 0,
				 2, 1, 1, 2, 1, 2, 4, 1, 2, 2, 1, 2, 1,
				 2, 1, 1, 2, 1, 2, 1, 2, 2, 1, 2, 2, 0,

	  /*1981*/	 1, 2, 1, 1, 2, 1, 1, 2, 2, 1, 2, 2, 0,
				 2, 1, 2, 1, 3, 2, 1, 1, 2, 2, 1, 2, 2,
				 2, 1, 2, 1, 1, 2, 1, 1, 2, 1, 2, 2, 0,
				 2, 1, 2, 2, 1, 1, 2, 1, 1, 2, 3, 2, 2,
				 1, 2, 2, 1, 2, 1, 2, 1, 1, 2, 1, 2, 0,
				 1, 2, 2, 1, 2, 2, 1, 2, 1, 2, 1, 1, 0,
				 2, 1, 2, 2, 1, 2, 3, 2, 2, 1, 2, 1, 2,
				 1, 1, 2, 1, 2, 1, 2, 2, 1, 2, 2, 1, 0,
				 2, 1, 1, 2, 1, 2, 1, 2, 2, 1, 2, 2, 0,
				 1, 2, 1, 1, 2, 3, 1, 2, 1, 2, 2, 2, 2,

	  /*1991*/	 1, 2, 1, 1, 2, 1, 1, 2, 1, 2, 2, 2, 0,
				 1, 2, 2, 1, 1, 2, 1, 1, 2, 1, 2, 2, 0,
				 1, 2, 2, 3, 2, 1, 2, 1, 1, 2, 1, 2, 1,
				 2, 2, 2, 1, 2, 1, 2, 1, 1, 2, 1, 2, 0,
				 1, 2, 2, 1, 2, 2, 1, 2, 3, 2, 1, 1, 2,
				 1, 2, 1, 2, 2, 1, 2, 1, 2, 2, 1, 2, 0,
				 1, 1, 2, 1, 2, 1, 2, 2, 1, 2, 2, 1, 0,
				 2, 1, 1, 2, 1, 3, 2, 2, 1, 2, 2, 2, 1,
				 2, 1, 1, 2, 1, 1, 2, 1, 2, 2, 2, 1, 0,
				 2, 2, 1, 1, 2, 1, 1, 2, 1, 2, 2, 1, 0,

	  /*2001*/	 2, 2, 2, 1, 3, 2, 1, 1, 2, 1, 2, 1, 2,
				 2, 2, 1, 2, 1, 2, 1, 1, 2, 1, 2, 1, 0,
				 2, 2, 1, 2, 2, 1, 2, 1, 1, 2, 1, 2, 0,
				 1, 2, 3, 2, 2, 1, 2, 1, 2, 2, 1, 1, 2,
				 1, 2, 1, 2, 1, 2, 2, 1, 2, 2, 1, 2, 0,
				 1, 1, 2, 1, 2, 1, 2, 3, 2, 2, 1, 2, 2,
				 1, 1, 2, 1, 1, 2, 1, 2, 2, 2, 1, 2, 0,
				 2, 1, 1, 2, 1, 1, 2, 1, 2, 2, 1, 2, 0,
				 2, 2, 1, 1, 2, 3, 1, 2, 1, 2, 1, 2, 2,
				 2, 1, 2, 1, 2, 1, 1, 2, 1, 2, 1, 2, 0,

	  /*2011*/	 2, 1, 2, 2, 1, 2, 1, 1, 2, 1, 2, 1, 0,
				 2, 1, 2, 4, 2, 1, 2, 1, 1, 2, 1, 2, 1,
				 2, 1, 2, 2, 1, 2, 1, 2, 1, 2, 1, 2, 0,
				 1, 2, 1, 2, 1, 2, 1, 2, 2, 3, 2, 1, 2,
				 1, 2, 1, 1, 2, 1, 2, 2, 2, 1, 2, 2, 0,
				 1, 1, 2, 1, 1, 2, 1, 2, 2, 1, 2, 2, 0,
				 2, 1, 1, 2, 1, 3, 2, 1, 2, 1, 2, 2, 2,
				 1, 2, 1, 2, 1, 1, 2, 1, 2, 1, 2, 2, 0,
				 2, 1, 2, 1, 2, 1, 1, 2, 1, 2, 1, 2, 0,
				 2, 1, 2, 2, 3, 2, 1, 1, 2, 1, 2, 1, 2,

	  /*2021*/	 1, 2, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 0,
				 2, 1, 2, 1, 2, 2, 1, 2, 1, 2, 1, 2, 0,
				 1, 2, 3, 2, 1, 2, 1, 2, 2, 1, 2, 1, 2,
				 1, 2, 1, 1, 2, 1, 2, 2, 1, 2, 2, 1, 0,
				 2, 1, 2, 1, 1, 2, 3, 2, 1, 2, 2, 2, 1,
				 2, 1, 2, 1, 1, 2, 1, 2, 1, 2, 2, 2, 0,
				 1, 2, 1, 2, 1, 1, 2, 1, 1, 2, 2, 2, 0,
				 1, 2, 2, 1, 2, 3, 1, 2, 1, 1, 2, 2, 1,
				 2, 2, 1, 2, 2, 1, 1, 2, 1, 1, 2, 2, 0,
				 1, 2, 1, 2, 2, 1, 2, 1, 2, 1, 2, 1, 0,

	  /*2031*/	 2, 1, 2, 3, 2, 1, 2, 2, 1, 2, 1, 2, 1,
				 2, 1, 1, 2, 1, 2, 2, 1, 2, 2, 1, 2, 0,
				 1, 2, 1, 1, 2, 1, 2, 3, 2, 2, 2, 1, 2,
				 1, 2, 1, 1, 2, 1, 2, 1, 2, 2, 2, 1, 0,
				 2, 1, 2, 1, 1, 2, 1, 1, 2, 2, 1, 2, 0,
				 2, 2, 1, 2, 1, 1, 4, 1, 1, 2, 1, 2, 2,
				 2, 2, 1, 2, 1, 1, 2, 1, 1, 2, 1, 2, 0,
				 2, 2, 1, 2, 1, 2, 1, 2, 1, 1, 2, 1, 0,
				 2, 2, 1, 2, 2, 3, 2, 1, 2, 1, 2, 1, 1,
				 2, 1, 2, 2, 1, 2, 2, 1, 2, 1, 2, 1, 0,

	  /*2041*/	 2, 1, 1, 2, 1, 2, 2, 1, 2, 2, 1, 2, 0,
				 1, 2, 3, 1, 2, 1, 2, 1, 2, 2, 2, 1, 2,
				 1, 2, 1, 1, 2, 1, 1, 2, 2, 1, 2, 2, 0 };

	  static char *yuk[10] = { "갑", "을", "병", "정", "무",
								 "기", "경", "신", "임", "계" };
	  static char *gap[12] = { "자", "축", "인", "묘", "진", "사",
								 "오", "미", "신", "유", "술", "해" };
	  static char *ddi[12] = { "쥐", "소", "범", "토끼","용",
							   "뱀", "말", "양", "원숭이", "닭",
							   "개", "돼지"};
	  char week[7][4] = { "일", "월", "화", "수", "목", "금", "토" };
	  int syear, smonth, sday, shour, smin, ssec;	   /* year, month, day */
	  int lyear, lmonth, lday;		/* calculated solar date */
	  int m1, m2, i, j, i1, j1, jcount, ll, w, m0;
	  int dt[163];
	  long td, td0, td1, td2, k11;
	  static m[12] = { 31, 0, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31 };
	  char temp[10];

	  struct tm *tp;
	  time_t t;

	  t = time(NULL);
	  tp = localtime(&t);

	  for(i=0; i<163; i++) {
		 dt[i] = 0;
		 for(j=0; j<12; j++) {
			switch(kk[i][j])
			{
				case 1:
				case 3:
					 dt[i] = dt[i] + 29;
					 break;
				case 2:
				case 4:
					 dt[i] = dt[i] + 30;
			}
		 }
		 switch(kk[i][12])
		 {
			case 0:
				 break;
			case 1:
			case 3:
				 dt[i] = dt[i] + 29;
				 break;
			case 2:
			case 4:
				 dt[i] = dt[i] + 30;
				 break;
		 }
	  }

	  /* 1. 1. 1. - 1910. 2. 10. */
	  td1 = 1880*365L + 1880/4 - 1880/100 + 1880/400 + 30;

	  syear = tp->tm_year;
	  smonth = tp->tm_mon+1;
	  sday = tp->tm_mday;
	  shour = tp->tm_hour;
	  smin = tp->tm_min;
	  ssec = tp->tm_sec;

	  if(syear > 95)
	  {
		  sprintf(temp, "19%d", syear);
	  }
	  else
	  {
		  sprintf(temp, "20%d", syear);
	  }

	  syear = atoi(temp);

	  /* ## 1. 1. 1. - syear. smonth. sday. ## */
	  k11 = (long)(syear-1);
	  td2 = k11*365L + k11/4L - k11/100L + k11/400L;
	  ll = syear%400==0 || syear%100!=0 && syear%4==0;
	  if(ll) m[1] = 29;
	  else	 m[1] = 28;
	  if( sday > m[smonth-1] ) {				   /* Input */
		 printf("\nInput data error !!");  /* Data  */
		 return;						/* Check */
	  }
	  for(i=0; i<smonth-1; i++) td2 = td2 + (long)m[i];
	  td2 = td2 + (long)sday;

	  /* ## 1881. 1. 30. - syear. smonth. sday. ## */
	  td = td2 - td1 + 1;

	  /* ## Lunar Year Caculation ## */
	  td0 = (long)dt[0];
	  for(i=0; i<163; i++) {
		if( td <= td0 ) break;
		td0 = td0 + (long)dt[i+1];
	  }
	  lyear = i + 1881;  /* Calculated Lunar Year */

	  /* ## Lunar Month Calculation ## */
	  td0 = td0 - (long)dt[i];
	  td = td - td0;
	  if(kk[i][12] != 0) jcount = 13;
	  else				 jcount = 12;
	  m2 = 0;
	  for(j=0; j<jcount; j++) {
		 if( kk[i][j] <=2 ) m2++;
		 if( kk[i][j] <=2 ) m1 = kk[i][j] + 28;
		 else				m1 = kk[i][j] + 26;
		 if( td <= (long)m1 ) break;
		 td = td - (long)m1;
	  }
	  m0 = j;
	  lmonth = m2;	/* Calculated Lunar Month */

	  lday = td;  /* Calculated Lunar Day */

	  w = (short) (td2 % 7L);	/* Week of Day */

	  i = (int)( (td2+4L) % 10L);
	  j = (int)( (td2+2L) % 12L);
	  i1 = ( lyear + 6 ) % 10;
	  j1 = ( lyear + 8 ) % 12;

	  if( (int)kk[lyear-1881][12] != 0 && (int)kk[lyear-1881][m0] > 2 )
	  {
		  // printf("윤년");
	  }

	  sprintf(outbuff,"%d-%02d-%02d",lyear, lmonth, lday);
	  return(outbuff);
//	  printf("%s%s년 %s띠",yuk[i1], gap[j1], ddi[j1]);
//	  if( (int)kk[lyear-1881][12] != 0 && (int)kk[lyear-1881][m0] > 2 )
//													printf("(LEAP) ");
}


